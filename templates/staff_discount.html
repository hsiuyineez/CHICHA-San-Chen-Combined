{% extends "bases.html" %}
{% block title %}CHICHA San Chen - Staff Discount{% endblock %}

{% block content %}
<script>
    function showPopup(message) {
        alert(message);
    }

    function handleCollect(button, voucherCode) {
        event.preventDefault();  // Prevent the form from submitting immediately
        let confirmBox = confirm("Congratulations! You have collected a voucher.");
        if (confirmBox) {
            button.closest("form").submit();  // Submit the form if the user clicks OK
        }
    }
</script>

<!-- Flash Message Display -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-success text-center">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="container-fluid position-relative p-0" style="height: 100vh; background-image: url('{{ url_for('static', filename='img_1.png') }}'); background-size: cover; background-position: center;">
    <div class="welcome-section position-absolute top-50 start-50 translate-middle text-center text-white">
        <h1 class="display-4">Staff Discount</h1>
    </div>
</div>

<div class="container my-5">
    <h2 class="text-center">Available Discounts</h2>
    <table class="table table-bordered table-striped mt-4">
        <thead>
            <tr>
                <th>Code</th>
                <th>Description</th>
                <th>Collection</th>
            </tr>
        </thead>
        <tbody>
            {% for voucher in vouchers %}
                <tr>
                    <td>{{ voucher.code }}</td>
                    <td>{{ voucher.description }}</td>
                    <td>
                        <form action="/collect/{{ voucher.code }}" method="POST">
                            {% if voucher.code in collected_vouchers %}
                                <button type="button" class="btn btn-secondary collect" disabled>Collected</button>
                                {% if collected_vouchers[voucher.code]['collected_at'] %}
                                    <small>Collected on {{ collected_vouchers[voucher.code]['collected_at'].strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                {% else %}
                                    <small>Collection date not available</small>
                                {% endif %}
                            {% else %}
                                <button type="submit" class="btn btn-primary collect" onclick="handleCollect(this, '{{ voucher.code }}')">Collect</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<script>
    function showModal(button) {
        // Show alert pop-up
        alert("Congratulations! You have collected a voucher.");

        // Change button text to "Collected" and disable it
        button.innerText = "Collected";
        button.classList.remove("btn-primary");
        button.classList.add("btn-secondary");
        button.disabled = true;

        // Append date and time
        let now = new Date();
        let formattedDate = now.toISOString().slice(0, 19).replace("T", " ");
        button.insertAdjacentHTML("afterend", `<br><small>Collected on ${formattedDate}</small>`);

        return true;  // Allow form submission
    }
</script>

{% endblock %}
